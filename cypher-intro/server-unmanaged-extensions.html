<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>35.2. Unmanaged Extensions -  - The Neo4j Manual v2.2-SNAPSHOT</title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="prev" href="server-plugins.html" title="35.1. Server Plugins" /><link rel="next" href="server-unmanaged-extensions-testing.html" title="35.3. Testing your extension" /><link rel="copyright" href="ln-d5e39.html" title="License: Creative Commons 3.0" /><meta name="Section-title" content="35.2. Unmanaged Extensions" /><script type="text/javascript">
      //The id for tree cookie
      var treeCookieId = "treeview-75136";
      var language = "en";
      var w = new Object();
      //Localization
      txt_filesfound = 'Results';
      txt_enter_at_least_1_char = "You must enter at least one character.";
      txt_browser_not_supported = "JavaScript is disabled on your browser. Please enable JavaScript to enjoy all the features of this site.";
      txt_please_wait = "Please wait. Search in progress...";
      txt_results_for = "Results for: ";
    </script><meta name="viewport" content="width=device-width, initial-scale=1" /><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" /><link rel="stylesheet" type="text/css" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/themes/redmond/jquery-ui.min.css" /><link rel="stylesheet" type="text/css" href="common/jquery/treeview/jquery.treeview.css" /><link rel="stylesheet" type="text/css" href="common/css/positioning.css" /><link rel="stylesheet" type="text/css" href="common/css/style.css" /><!--[if IE]>
  <link rel="stylesheet" type="text/css" href="../common/css/ie.css"/>
  <![endif]--><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" /><script type="text/javascript" src="common/browserDetect.js"></script><script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script><script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js"></script><script type="text/javascript" src="common/jquery/jquery.highlight.js"></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script><script type="text/javascript" src="common/jquery/treeview/jquery.treeview.min.js"></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-scrollTo/1.4.11/jquery.scrollTo.min.js"></script><script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script><script type="text/javascript" src="common/main.js"></script><script type="text/javascript" src="search/l10n.js"></script><script type="text/javascript" src="search/htmlFileInfoList.js"></script><script type="text/javascript" src="common/search.js"></script><script type="text/javascript" src="search/stemmers/en_stemmer.js"></script><script type="text/javascript" src="search/index-1.js"></script><script type="text/javascript" src="search/index-2.js"></script><script type="text/javascript" src="search/index-3.js"></script>


<!-- favicon -->

<link rel="shortcut icon" href="common/images/favicon.ico" />

<!-- fonts -->

<link href='//fonts.googleapis.com/css?family=Ubuntu+Mono|PT+Sans:400,700,400italic' rel='stylesheet' type='text/css' />

<!-- Syntax Highlighter -->

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/codemirror.min.css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/theme/neo.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/codemirror.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/addon/runmode/runmode.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/mode/javascript/javascript.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/mode/shell/shell.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/mode/sql/sql.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/mode/xml/xml.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/mode/clike/clike.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/mode/cypher/cypher.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/mode/properties/properties.min.js"></script>

<script src="js/colorize.js"></script>
 
<script type="text/javascript">
  $(function (){
    CodeMirror.colorize();
  });
</script>

<!-- Cypher Console -->

<script type="text/javascript" src="js/console.js"></script>
<script type="text/javascript" src="js/cypherconsole.js"></script>

<!-- Version -->
<script type="text/javascript" src="js/version.js"></script>
<script type="text/javascript" src="js/versionswitcher.js"></script>

<!-- Discuss -->
<script type="text/javascript" src="js/mutate.min.js"></script>
<script type="text/javascript" src="js/disqus.js"></script>

<script type="text/javascript">
    /*@cc_on @*/
    /*@
     $( '#content' ).addClass( 'internet-explorer' );
     @*/
</script>


</head><body><div id="header"><a href="index.html" id="logo"><img src="common/images/logo-neo4j.svg" alt="" /></a><h1><span id="book-title">The Neo4j Manual v2.2-SNAPSHOT</span><span>35.2. Unmanaged Extensions</span></h1><div id="navheader"><!----><div id="navLinks"><span><a id="showHideButton" href="#" class="pointLeft" tabindex="5" title="Show/Hide TOC tree"><i class="fa fa-columns"></i> Contents
            </a></span><span><a accesskey="p" id="navLinkPrevious" tabindex="5" href="server-plugins.html"><i class="fa fa-arrow-circle-left"></i> Prev</a></span><span><a accesskey="u" id="navLinkUp" tabindex="5" href="server-extending.html">Up <i class="fa fa-arrow-circle-up"></i></a></span><span><a accesskey="n" id="navLinkNext" tabindex="5" href="server-unmanaged-extensions-testing.html">Next <i class="fa fa-arrow-circle-right"></i></a></span></div></div></div><div id="content"><section class="section" id="server-unmanaged-extensions"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both">35.2. Unmanaged Extensions</h2></div></div></div><div class="toc"><ul class="toc"><li><span class="section"><a href="server-unmanaged-extensions.html#intro-unmanaged-extensions">Introduction to unmanaged extensions</a></span></li><li><span class="section"><a href="server-unmanaged-extensions.html#server-unmanaged-extensions-streaming">Streaming JSON responses</a></span></li><li><span class="section"><a href="server-unmanaged-extensions.html#server-unmanaged-extensions-execution-engine">Using Cypher in an unmanaged extension</a></span></li></ul></div>

<p>Sometimes you’ll want finer grained control over your application’s interactions with Neo4j than cypher provides.
For these situations you can use the unmanaged extension API.</p>
<div class="admonitionblock Caution"><table><tr><td class="icon"><img alt="[Caution]" src="images/icons/admon/caution.svg" /></td><td class="content"><b>Caution</b><p>This is a sharp tool, allowing users to deploy arbitrary <a class="ulink" href="http://en.wikipedia.org/wiki/JAX-RS" target="_blank">JAX-RS</a> classes to the server so be careful when using this.
In particular it’s easy to consume lots of heap space on the server and degrade performance.
If in doubt please ask for help via one of the community channels (see <a class="xref" href="community-support.html" title="Chapter 33. Community Support">Chapter 33, <em>Community Support</em></a>).</p></td></tr></table></div>
<section class="section" id="intro-unmanaged-extensions"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Introduction to unmanaged extensions</h3></div></div></div>

<p>The first step when writing an unmanaged extension is to create a project which includes dependencies to the JAX-RS and Neo4j core jars.
In Maven this would be achieved by adding the following lines to the pom file:</p>
<pre class="programlisting" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;javax.ws.rs&lt;/groupId&gt;
    &lt;artifactId&gt;javax.ws.rs-api&lt;/artifactId&gt;
    &lt;version&gt;2.0&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;</pre>
<pre class="programlisting" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.neo4j&lt;/groupId&gt;
    &lt;artifactId&gt;neo4j&lt;/artifactId&gt;
    &lt;version&gt;2.2-SNAPSHOT&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;</pre>
<p>Now we’re ready to write our extension.</p>
<p>In our code we’ll interact with the database using <code class="literal">GraphDatabaseService</code> which we can get access to by using the <code class="literal">@Context</code> annotation.
The following examples serves as a template which you can base your extension on:</p>
<p><strong>Unmanaged extension example </strong>
</p><pre class="programlisting" data-lang="java">@Path( "/helloworld" )
public class HelloWorldResource
{
    private final GraphDatabaseService database;

    public HelloWorldResource( @Context GraphDatabaseService database )
    {
        this.database = database;
    }

    @GET
    @Produces( MediaType.TEXT_PLAIN )
    @Path( "/{nodeId}" )
    public Response hello( @PathParam( "nodeId" ) long nodeId )
    {
        // Do stuff with the database
        return Response.status( Status.OK ).entity(
                ("Hello World, nodeId=" + nodeId).getBytes( Charset.forName("UTF-8") ) ).build();
    }
}
</pre><p>
</p>
<p>The full source code is found here:
<a class="ulink" href="https://github.com/neo4j/neo4j/blob/master/community/server-examples/src/main/java/org/neo4j/examples/server/unmanaged/HelloWorldResource.java" target="_blank">HelloWorldResource.java</a></p>
<p>Having built your code, the resulting jar file (and any custom dependencies) should be placed in the <code class="literal">$NEO4J_SERVER_HOME/plugins</code> directory.
We also need to tell Neo4j where to look for the extension by adding some configuration in the <span class="emphasis"><em>conf/neo4j-server.properties</em></span> file:</p>
<pre class="programlisting" data-lang="plain">#Comma separated list of JAXRS packages containing JAXRS Resource, one package name for each mountpoint.
org.neo4j.server.thirdparty_jaxrs_classes=org.neo4j.examples.server.unmanaged=/examples/unmanaged</pre>
<p>Our hello method will now respond to <code class="literal">GET</code> requests at the URI: <code class="literal">http://{neo4j_server}:{neo4j_port}/examples/unmanaged/helloworld/{nodeId}</code>. e.g.</p>
<pre class="programlisting" data-lang="bash">curl http://localhost:7474/examples/unmanaged/helloworld/123</pre>
<p>which results in</p>
<pre class="programlisting" data-lang="plain">Hello World, nodeId=123</pre>
</section>
<section class="section" id="server-unmanaged-extensions-streaming"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Streaming JSON responses</h3></div></div></div>

<p>When writing unmanaged extensions we have greater control over the amount of memory that our Neo4j queries use.
If we keep too much state around it can lead to more frequent full Garbage Collection and subsequent unresponsiveness by the Neo4j server.</p>
<p>A common way that state can creep in is the creation of JSON objects to represent the result of a query which we then send back to our application.
Neo4j’s Transactional Cypher HTTP endpoint (see <a class="xref" href="rest-api-transactional.html" title="22.1. Transactional Cypher HTTP endpoint">Section 22.1, “Transactional Cypher HTTP endpoint”</a>) streams responses back to the client and we should follow in its footsteps.</p>
<p>For example, the following unmanaged extension streams an array of a person’s colleagues:</p>
<p><strong>Unmanaged extension streaming example </strong>
</p><pre class="programlisting" data-lang="java">@Path("/colleagues")
public class ColleaguesResource
{
    private GraphDatabaseService graphDb;
    private final ObjectMapper objectMapper;

    private static final DynamicRelationshipType ACTED_IN = DynamicRelationshipType.withName( "ACTED_IN" );
    private static final Label PERSON = DynamicLabel.label( "Person" );

    public ColleaguesResource( @Context GraphDatabaseService graphDb )
    {
        this.graphDb = graphDb;
        this.objectMapper = new ObjectMapper();
    }

    @GET
    @Path("/{personName}")
    public Response findColleagues( final @PathParam("personName") String personName )
    {
        StreamingOutput stream = new StreamingOutput()
        {
            @Override
            public void write( OutputStream os ) throws IOException, WebApplicationException
            {
                JsonGenerator jg = objectMapper.getJsonFactory().createJsonGenerator( os, JsonEncoding.UTF8 );
                jg.writeStartObject();
                jg.writeFieldName( "colleagues" );
                jg.writeStartArray();

                try ( Transaction tx = graphDb.beginTx();
                      ResourceIterator&lt;Node&gt; persons = graphDb.findNodes( PERSON, "name", personName ) )
                {
                    while ( persons.hasNext() )
                    {
                        Node person = persons.next();
                        for ( Relationship actedIn : person.getRelationships( ACTED_IN, OUTGOING ) )
                        {
                            Node endNode = actedIn.getEndNode();
                            for ( Relationship colleagueActedIn : endNode.getRelationships( ACTED_IN, INCOMING ) )
                            {
                                Node colleague = colleagueActedIn.getStartNode();
                                if ( !colleague.equals( person ) )
                                {
                                    jg.writeString( colleague.getProperty( "name" ).toString() );
                                }
                            }
                        }
                    }
                    tx.success();
                }

                jg.writeEndArray();
                jg.writeEndObject();
                jg.flush();
                jg.close();
            }
        };

        return Response.ok().entity( stream ).type( MediaType.APPLICATION_JSON ).build();
    }
}
</pre><p>
</p>
<p>The full source code is found here:
<a class="ulink" href="https://github.com/neo4j/neo4j/blob/master/community/server-examples/src/main/java/org/neo4j/examples/server/unmanaged/ColleaguesResource.java" target="_blank">ColleaguesResource.java</a></p>
<p>As well as depending on JAX-RS API this example also uses Jackson — a Java JSON library.
You’ll need to add the following dependency to your Maven POM file (or equivalent):</p>
<pre class="programlisting" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.codehaus.jackson&lt;/groupId&gt;
    &lt;artifactId&gt;jackson-mapper-asl&lt;/artifactId&gt;
    &lt;version&gt;1.9.7&lt;/version&gt;
&lt;/dependency&gt;</pre>
<p>Our <code class="literal">findColleagues</code> method will now respond to <code class="literal">GET</code> requests at the URI: <code class="literal">http://{neo4j_server}:{neo4j_port}/examples/unmanaged/colleagues/{personName}</code>.
For example:</p>
<pre class="programlisting" data-lang="bash">curl http://localhost:7474/examples/unmanaged/colleagues/Keanu%20Reeves</pre>
<p>which results in</p>
<pre class="programlisting" data-lang="plain">{"colleagues":["Hugo Weaving","Carrie-Anne Moss","Laurence Fishburne"]}</pre>
</section>
<section class="section" id="server-unmanaged-extensions-execution-engine"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Using Cypher in an unmanaged extension</h3></div></div></div>

<p>You can execute Cypher queries by using the <code class="literal">GraphDatabaseService</code> that is injected into the extension.</p>
<div class="admonitionblock Note"><table><tr><td class="icon"><img alt="[Note]" src="images/icons/admon/note.svg" /></td><td class="content"><b>Note</b><p>In Neo4j versions prior to 2.2 you had to retrieve an <code class="literal">ExecutionEngine</code> to execute queries.
This has been deprecated, and we recommend you to update any existing code to use <code class="literal">GraphDatabaseService</code> instead.</p></td></tr></table></div>
<p>For example, the following unmanaged extension retrieves a person’s colleagues using Cypher:</p>
<p><strong>Unmanaged extension Cypher execution example </strong>
</p><pre class="programlisting" data-lang="java">@Path("/colleagues-cypher-execution")
public class ColleaguesCypherExecutionResource
{
    private final ObjectMapper objectMapper;
    private GraphDatabaseService graphDb;

    public ColleaguesCypherExecutionResource( @Context GraphDatabaseService graphDb )
    {
        this.graphDb = graphDb;
        this.objectMapper = new ObjectMapper();
    }

    @GET
    @Path("/{personName}")
    public Response findColleagues( final @PathParam("personName") String personName )
    {
        final Map&lt;String, Object&gt; params = MapUtil.map( "personName", personName );

        StreamingOutput stream = new StreamingOutput()
        {
            @Override
            public void write( OutputStream os ) throws IOException, WebApplicationException
            {
                JsonGenerator jg = objectMapper.getJsonFactory().createJsonGenerator( os, JsonEncoding.UTF8 );
                jg.writeStartObject();
                jg.writeFieldName( "colleagues" );
                jg.writeStartArray();

                try ( Transaction tx = graphDb.beginTx();
                      Result result = graphDb.execute( colleaguesQuery(), params ) )
                {
                    while ( result.hasNext() )
                    {
                        Map&lt;String,Object&gt; row = result.next();
                        jg.writeString( ((Node) row.get( "colleague" )).getProperty( "name" ).toString() );
                    }
                    tx.success();
                }

                jg.writeEndArray();
                jg.writeEndObject();
                jg.flush();
                jg.close();
            }
        };

        return Response.ok().entity( stream ).type( MediaType.APPLICATION_JSON ).build();
    }

    private String colleaguesQuery()
    {
        return "MATCH (p:Person {name: {personName} })-[:ACTED_IN]-&gt;()&lt;-[:ACTED_IN]-(colleague) RETURN colleague";
    }
}
</pre><p>
</p>
<p>The full source code is found here:
<a class="ulink" href="https://github.com/neo4j/neo4j/blob/master/community/server-examples/src/main/java/org/neo4j/examples/server/unmanaged/ColleaguesCypherExecutionResource.java" target="_blank">ColleaguesCypherExecutionResource.java</a></p>
<p>Our <code class="literal">findColleagues</code> method will now respond to <code class="literal">GET</code> requests at the URI: <code class="literal">http://{neo4j_server}:{neo4j_port}/examples/unmanaged/colleagues-cypher-execution/{personName}</code>. e.g.</p>
<pre class="programlisting" data-lang="bash">curl http://localhost:7474/examples/unmanaged/colleagues-cypher-execution/Keanu%20Reeves</pre>
<p>which results in</p>
<pre class="programlisting" data-lang="plain">{"colleagues":["Hugo Weaving","Carrie-Anne Moss","Laurence Fishburne"]}</pre>
</section>
</section>

 <footer>
   <p>
   © Copyright
   <a href="http://creativecommons.org/licenses/by-sa/3.0/"><img id="copyright-img" src="images/by-sa.svg" alt="CC BY-SA 3.0" title="Creative Commons Attribution-ShareAlike 3.0"></a>
   <a href="http://neo4j.com/"><img id="neotech-logo" src="images/neo-technology.svg" alt="Neo Technology"></a>
   </p>
 </footer>
  <script type="text/javascript">

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    //Allow Linker
    ga('create', 'UA-1192232-34','auto', {'allowLinker': true});
    ga('send', 'pageview');

    // Load the plugin.
    ga('require', 'linker');

    // Define which domains to autoLink.
    ga('linker:autoLink', ['neo4j.org','neo4j.com','neotechnology.com','graphdatabases.com','graphconnect.com']);
  </script>

</div></body></html>