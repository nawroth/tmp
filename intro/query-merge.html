<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>12.2. Merge -  - The Neo4j Manual v2.2-SNAPSHOT</title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="prev" href="query-create.html" title="12.1. Create" /><link rel="next" href="query-set.html" title="12.3. Set" /><link rel="copyright" href="ln-d5e39.html" title="License: Creative Commons 3.0" /><meta name="Section-title" content="12.2. Merge" /><script type="text/javascript">
      //The id for tree cookie
      var treeCookieId = "treeview-76183";
      var language = "en";
      var w = new Object();
      //Localization
      txt_filesfound = 'Results';
      txt_enter_at_least_1_char = "You must enter at least one character.";
      txt_browser_not_supported = "JavaScript is disabled on your browser. Please enable JavaScript to enjoy all the features of this site.";
      txt_please_wait = "Please wait. Search in progress...";
      txt_results_for = "Results for: ";
    </script><meta name="viewport" content="width=device-width, initial-scale=1" /><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" /><link rel="stylesheet" type="text/css" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/themes/redmond/jquery-ui.min.css" /><link rel="stylesheet" type="text/css" href="common/jquery/treeview/jquery.treeview.css" /><link rel="stylesheet" type="text/css" href="common/css/positioning.css" /><link rel="stylesheet" type="text/css" href="common/css/style.css" /><!--[if IE]>
  <link rel="stylesheet" type="text/css" href="../common/css/ie.css"/>
  <![endif]--><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" /><script type="text/javascript" src="common/browserDetect.js"></script><script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script><script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js"></script><script type="text/javascript" src="common/jquery/jquery.highlight.js"></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script><script type="text/javascript" src="common/jquery/treeview/jquery.treeview.min.js"></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-scrollTo/1.4.11/jquery.scrollTo.min.js"></script><script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script><script type="text/javascript" src="common/main.js"></script><script type="text/javascript" src="search/l10n.js"></script><script type="text/javascript" src="search/htmlFileInfoList.js"></script><script type="text/javascript" src="common/search.js"></script><script type="text/javascript" src="search/stemmers/en_stemmer.js"></script><script type="text/javascript" src="search/index-1.js"></script><script type="text/javascript" src="search/index-2.js"></script><script type="text/javascript" src="search/index-3.js"></script>


<!-- favicon -->

<link rel="shortcut icon" href="common/images/favicon.ico" />

<!-- fonts -->

<link href='//fonts.googleapis.com/css?family=Ubuntu+Mono|PT+Sans:400,700,400italic' rel='stylesheet' type='text/css' />

<!-- Syntax Highlighter -->

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.10.0/codemirror.min.css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.10.0/theme/neo.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.10.0/codemirror.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.10.0/addon/runmode/runmode.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.10.0/mode/javascript/javascript.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.10.0/mode/shell/shell.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.10.0/mode/sql/sql.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.10.0/mode/xml/xml.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.10.0/mode/clike/clike.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.10.0/mode/cypher/cypher.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.10.0/mode/properties/properties.min.js"></script>

<script src="js/colorize.js"></script>
 
<script type="text/javascript">
  $(function (){
    CodeMirror.colorize();
  });
</script>

<!-- Cypher Console -->

<script type="text/javascript" src="js/console.js"></script>
<script type="text/javascript" src="js/cypherconsole.js"></script>

<!-- Version -->
<script type="text/javascript" src="js/version.js"></script>
<script type="text/javascript" src="js/versionswitcher.js"></script>

<!-- Discuss -->
<script type="text/javascript" src="js/mutate.min.js"></script>
<script type="text/javascript" src="js/disqus.js"></script>

<script type="text/javascript">
    /*@cc_on @*/
    /*@
     $( '#content' ).addClass( 'internet-explorer' );
     @*/
</script>


</head><body><div id="header"><a href="index.html" id="logo"><img src="common/images/logo-neo4j.svg" alt="" /></a><h1><span id="book-title">The Neo4j Manual v2.2-SNAPSHOT</span><span>12.2. Merge</span></h1><div id="navheader"><!----><div id="navLinks"><span><a id="showHideButton" href="#" class="pointLeft" tabindex="5" title="Show/Hide TOC tree"><i class="fa fa-columns"></i> Contents
            </a></span><span><a accesskey="p" id="navLinkPrevious" tabindex="5" href="query-create.html"><i class="fa fa-arrow-circle-left"></i> Prev</a></span><span><a accesskey="u" id="navLinkUp" tabindex="5" href="query-write.html">Up <i class="fa fa-arrow-circle-up"></i></a></span><span><a accesskey="n" id="navLinkNext" tabindex="5" href="query-set.html">Next <i class="fa fa-arrow-circle-right"></i></a></span></div></div></div><div id="content"><section class="section" id="query-merge"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both">12.2. Merge</h2></div></div></div><div class="toc"><ul class="toc"><li><span class="section"><a href="query-merge.html#_introduction_4">Introduction</a></span></li><li><span class="section"><a href="query-merge.html#_merge_nodes">Merge nodes</a></span></li><li><span class="section"><a href="query-merge.html#_use_on_create_and_on_match">Use ON CREATE and ON MATCH</a></span></li><li><span class="section"><a href="query-merge.html#_merge_relationships">Merge relationships</a></span></li><li><span class="section"><a href="query-merge.html#_using_unique_constraints_with_merge">Using unique constraints with MERGE</a></span></li><li><span class="section"><a href="query-merge.html#merge-using-map-parameters-with-merge">Using map parameters with MERGE</a></span></li></ul></div>

<div class="abstract">
<p>The <code class="literal">MERGE</code> clause ensures that a pattern exists in the graph.
Either the pattern already exists, or it needs to be created.</p>
</div>
<section class="section" id="_introduction_4"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Introduction</h3></div></div></div>

<p><code class="literal">MERGE</code> either matches existing nodes and binds them, or it creates new data and binds that.
It’s like a combination of <code class="literal">MATCH</code> and <code class="literal">CREATE</code> that additionally allows you to specify what happens if the data was matched or created.</p>
<p>For example, you can specify that the graph must contain a node for a user with a certain name.
If there isn’t a node with the correct name, a new node will be created and its name property set.</p>
<p>When using <code class="literal">MERGE</code> on full patterns, the behavior is that either the whole pattern matches, or the whole pattern is created.
<code class="literal">MERGE</code> will not partially use existing patterns — it’s all or nothing.
If partial matches are needed, this can be accomplished by splitting a pattern up into multiple <code class="literal">MERGE</code> clauses.</p>
<p>As with <code class="literal">MATCH</code>, <code class="literal">MERGE</code> can match multiple occurrences of a pattern.
If there are multiple matches, they will all be passed on to later stages of the query.</p>
<p>The last part of <code class="literal">MERGE</code> is the <code class="literal">ON CREATE</code> and <code class="literal">ON MATCH</code>.
These allow a query to express additional changes to the properties of a node or relationship, depending on if the element was <code class="literal">MATCH</code>ed in the database or if it was <code class="literal">CREATE</code>d.</p>
<p>The following graph is used for the examples below:</p>
<div class="figure" id="d5e10528"><p class="title"><strong>Figure 12.1. Graph</strong></p><div class="figure-contents">
<a class="ulink" href="images/cypher-merge-graph.svg" target="_blank">
<span class="inlinemediaobject"><img src="images/cypher-merge-graph.svg" alt="cypher-merge-graph.svg" /></span>
</a>
</div></div>
</section>
<section class="section" id="_merge_nodes"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge nodes</h3></div></div></div>

<section class="section" id="merge-merge-single-node-with-a-label"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge single node with a label</h4></div></div></div>

<p>Merging a single node with a given label.</p>
<p><strong>Query </strong>
</p><pre class="programlisting" data-lang="cypher">MERGE (robert:Critic)
RETURN robert, labels(robert)</pre><p>
</p>
<p>Because there are no nodes labeled <code class="literal">Critic</code> in the database, a new node is created.</p>
<div class="queryresult table" id="d5e10547"><p class="title"><strong>Result</strong></p><div class="queryresult table-contents"><table cellspacing="0" cellpadding="0"><thead><tr><th>robert</th><th>labels(robert)</th></tr></thead><tfoot><tr><th colspan="2">1 row
</th></tr><tr><th colspan="2">Nodes created: 1
</th></tr><tr><th colspan="2">Labels added: 1</th></tr></tfoot><tbody><tr><td><p><code class="literal">Node[7]{}</code></p></td><td><p><code class="literal">["Critic"]</code></p></td></tr></tbody></table></div></div>
<p class="cypherconsole"><strong>Try this query live </strong><span class="database">create constraint on (n:`Person`) assert n.`name` is unique
create constraint on (n:`Person`) assert n.`role` is unique
create (_0:`Person` {`name`:"Oliver Stone"})
create (_1:`Person` {`name`:"Charlie Sheen"})
create (_2:`Person` {`name`:"Martin Sheen"})
create (_3:`Movie` {`name`:"TheAmericanPresident", `title`:"The American President"})
create (_4:`Movie` {`name`:"WallStreet", `title`:"Wall Street"})
create (_5:`Person` {`name`:"Rob Reiner"})
create (_6:`Person` {`name`:"Michael Douglas"})
create _0-[:`DIRECTED`]-&gt;_4
create _1-[:`ACTED_IN`]-&gt;_4
create _1-[:`FATHER`]-&gt;_2
create _2-[:`ACTED_IN`]-&gt;_3
create _2-[:`ACTED_IN`]-&gt;_4
create _5-[:`DIRECTED`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_4
</span><span class="command"><strong>
 merge (robert:Critic)
 return robert, labels(robert)</strong></span></p>
</section>
<section class="section" id="merge-merge-single-node-with-properties"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge single node with properties</h4></div></div></div>

<p>Merging a single node with properties where not all properties match any existing node.</p>
<p><strong>Query </strong>
</p><pre class="programlisting" data-lang="cypher">MERGE (charlie { name:'Charlie Sheen', age:10 })
RETURN charlie</pre><p>
</p>
<p>A new node with the name Charlie Sheen will be created since not all properties matched the existing Charlie Sheen node.</p>
<div class="queryresult table" id="d5e10584"><p class="title"><strong>Result</strong></p><div class="queryresult table-contents"><table cellspacing="0" cellpadding="0"><thead><tr><th>charlie</th></tr></thead><tfoot><tr><th>1 row
</th></tr><tr><th>Nodes created: 1
</th></tr><tr><th>Properties set: 2</th></tr></tfoot><tbody><tr><td><p><code class="literal">Node[7]{name:"Charlie Sheen",age:10}</code></p></td></tr></tbody></table></div></div>
<p class="cypherconsole"><strong>Try this query live </strong><span class="database">create constraint on (n:`Person`) assert n.`name` is unique
create constraint on (n:`Person`) assert n.`role` is unique
create (_0:`Person` {`name`:"Oliver Stone"})
create (_1:`Person` {`name`:"Charlie Sheen"})
create (_2:`Person` {`name`:"Martin Sheen"})
create (_3:`Movie` {`name`:"TheAmericanPresident", `title`:"The American President"})
create (_4:`Movie` {`name`:"WallStreet", `title`:"Wall Street"})
create (_5:`Person` {`name`:"Rob Reiner"})
create (_6:`Person` {`name`:"Michael Douglas"})
create _0-[:`DIRECTED`]-&gt;_4
create _1-[:`ACTED_IN`]-&gt;_4
create _1-[:`FATHER`]-&gt;_2
create _2-[:`ACTED_IN`]-&gt;_3
create _2-[:`ACTED_IN`]-&gt;_4
create _5-[:`DIRECTED`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_4
</span><span class="command"><strong>
 merge (charlie {name:'Charlie Sheen', age:10})
 return charlie</strong></span></p>
</section>
<section class="section" id="merge-merge-single-node-specifying-both-label-and-property"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge single node specifying both label and property</h4></div></div></div>

<p>Merging a single node with both label and property matching an existing node.</p>
<p><strong>Query </strong>
</p><pre class="programlisting" data-lang="cypher">MERGE (michael:Person { name:'Michael Douglas' })
RETURN michael</pre><p>
</p>
<p>Michael Douglas will be matched and returned.</p>
<div class="queryresult table" id="d5e10616"><p class="title"><strong>Result</strong></p><div class="queryresult table-contents"><table cellspacing="0" cellpadding="0"><thead><tr><th>michael</th></tr></thead><tfoot><tr><th>1 row</th></tr></tfoot><tbody><tr><td><p><code class="literal">Node[6]{name:"Michael Douglas"}</code></p></td></tr></tbody></table></div></div>
<p class="cypherconsole"><strong>Try this query live </strong><span class="database">create constraint on (n:`Person`) assert n.`name` is unique
create constraint on (n:`Person`) assert n.`role` is unique
create (_0:`Person` {`name`:"Oliver Stone"})
create (_1:`Person` {`name`:"Charlie Sheen"})
create (_2:`Person` {`name`:"Martin Sheen"})
create (_3:`Movie` {`name`:"TheAmericanPresident", `title`:"The American President"})
create (_4:`Movie` {`name`:"WallStreet", `title`:"Wall Street"})
create (_5:`Person` {`name`:"Rob Reiner"})
create (_6:`Person` {`name`:"Michael Douglas"})
create _0-[:`DIRECTED`]-&gt;_4
create _1-[:`ACTED_IN`]-&gt;_4
create _1-[:`FATHER`]-&gt;_2
create _2-[:`ACTED_IN`]-&gt;_3
create _2-[:`ACTED_IN`]-&gt;_4
create _5-[:`DIRECTED`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_4
</span><span class="command"><strong>
 merge (michael:Person {name:'Michael Douglas'})
 return michael</strong></span></p>
</section>
</section>
<section class="section" id="_use_on_create_and_on_match"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Use ON CREATE and ON MATCH</h3></div></div></div>

<section class="section" id="merge-merge-with-on-create"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge with ON CREATE</h4></div></div></div>

<p>Merge a node and set properties if the node needs to be created.</p>
<p><strong>Query </strong>
</p><pre class="programlisting" data-lang="cypher">MERGE (keanu:Person { name:'Keanu Reeves' })
ON CREATE SET keanu.created = timestamp()
RETURN keanu</pre><p>
</p>
<p>Creates the Keanu node, and sets a timestamp on creation time.</p>
<div class="queryresult table" id="d5e10646"><p class="title"><strong>Result</strong></p><div class="queryresult table-contents"><table cellspacing="0" cellpadding="0"><thead><tr><th>keanu</th></tr></thead><tfoot><tr><th>1 row
</th></tr><tr><th>Nodes created: 1
</th></tr><tr><th>Properties set: 2
</th></tr><tr><th>Labels added: 1</th></tr></tfoot><tbody><tr><td><p><code class="literal">Node[7]{name:"Keanu Reeves",created:1423220758635}</code></p></td></tr></tbody></table></div></div>
<p class="cypherconsole"><strong>Try this query live </strong><span class="database">create constraint on (n:`Person`) assert n.`name` is unique
create constraint on (n:`Person`) assert n.`role` is unique
create (_0:`Person` {`name`:"Oliver Stone"})
create (_1:`Person` {`name`:"Charlie Sheen"})
create (_2:`Person` {`name`:"Martin Sheen"})
create (_3:`Movie` {`name`:"TheAmericanPresident", `title`:"The American President"})
create (_4:`Movie` {`name`:"WallStreet", `title`:"Wall Street"})
create (_5:`Person` {`name`:"Rob Reiner"})
create (_6:`Person` {`name`:"Michael Douglas"})
create _0-[:`DIRECTED`]-&gt;_4
create _1-[:`ACTED_IN`]-&gt;_4
create _1-[:`FATHER`]-&gt;_2
create _2-[:`ACTED_IN`]-&gt;_3
create _2-[:`ACTED_IN`]-&gt;_4
create _5-[:`DIRECTED`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_4
</span><span class="command"><strong>
 merge (keanu:Person {name:'Keanu Reeves'})
 on create set keanu.created = timestamp()
 return keanu</strong></span></p>
</section>
<section class="section" id="merge-merge-with-on-match"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge with ON MATCH</h4></div></div></div>

<p>Merging nodes and setting properties on found nodes.</p>
<p><strong>Query </strong>
</p><pre class="programlisting" data-lang="cypher">MERGE (person:Person)
ON MATCH SET person.found = TRUE RETURN person</pre><p>
</p>
<p>Finds all the <code class="literal">Person</code> nodes, sets a property on them, and returns them.</p>
<div class="queryresult table" id="d5e10681"><p class="title"><strong>Result</strong></p><div class="queryresult table-contents"><table cellspacing="0" cellpadding="0"><thead><tr><th>person</th></tr></thead><tfoot><tr><th>5 rows
</th></tr><tr><th>Properties set: 5</th></tr></tfoot><tbody><tr><td><p><code class="literal">Node[0]{name:"Oliver Stone",found:true}</code></p></td></tr><tr><td><p><code class="literal">Node[1]{name:"Charlie Sheen",found:true}</code></p></td></tr><tr><td><p><code class="literal">Node[2]{name:"Martin Sheen",found:true}</code></p></td></tr><tr><td><p><code class="literal">Node[5]{name:"Rob Reiner",found:true}</code></p></td></tr><tr><td><p><code class="literal">Node[6]{name:"Michael Douglas",found:true}</code></p></td></tr></tbody></table></div></div>
<p class="cypherconsole"><strong>Try this query live </strong><span class="database">create constraint on (n:`Person`) assert n.`name` is unique
create constraint on (n:`Person`) assert n.`role` is unique
create (_0:`Person` {`name`:"Oliver Stone"})
create (_1:`Person` {`name`:"Charlie Sheen"})
create (_2:`Person` {`name`:"Martin Sheen"})
create (_3:`Movie` {`name`:"TheAmericanPresident", `title`:"The American President"})
create (_4:`Movie` {`name`:"WallStreet", `title`:"Wall Street"})
create (_5:`Person` {`name`:"Rob Reiner"})
create (_6:`Person` {`name`:"Michael Douglas"})
create _0-[:`DIRECTED`]-&gt;_4
create _1-[:`ACTED_IN`]-&gt;_4
create _1-[:`FATHER`]-&gt;_2
create _2-[:`ACTED_IN`]-&gt;_3
create _2-[:`ACTED_IN`]-&gt;_4
create _5-[:`DIRECTED`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_4
</span><span class="command"><strong>
 merge (person:Person)
 on match set person.found = true
 return person</strong></span></p>
</section>
<section class="section" id="merge-merge-with-on-create-and-on-match"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge with ON CREATE and ON MATCH</h4></div></div></div>

<p>Merge a node and set properties if the node needs to be created.</p>
<p><strong>Query </strong>
</p><pre class="programlisting" data-lang="cypher">MERGE (keanu:Person { name:'Keanu Reeves' })
ON CREATE SET keanu.created = timestamp()
ON MATCH SET keanu.lastSeen = timestamp()
RETURN keanu</pre><p>
</p>
<p>The query creates the Keanu node, and sets a timestamp on creation time. If Keanu already existed, a different property would have been set.</p>
<div class="queryresult table" id="d5e10727"><p class="title"><strong>Result</strong></p><div class="queryresult table-contents"><table cellspacing="0" cellpadding="0"><thead><tr><th>keanu</th></tr></thead><tfoot><tr><th>1 row
</th></tr><tr><th>Nodes created: 1
</th></tr><tr><th>Properties set: 2
</th></tr><tr><th>Labels added: 1</th></tr></tfoot><tbody><tr><td><p><code class="literal">Node[7]{name:"Keanu Reeves",created:1423220759726}</code></p></td></tr></tbody></table></div></div>
<p class="cypherconsole"><strong>Try this query live </strong><span class="database">create constraint on (n:`Person`) assert n.`name` is unique
create constraint on (n:`Person`) assert n.`role` is unique
create (_0:`Person` {`name`:"Oliver Stone"})
create (_1:`Person` {`name`:"Charlie Sheen"})
create (_2:`Person` {`name`:"Martin Sheen"})
create (_3:`Movie` {`name`:"TheAmericanPresident", `title`:"The American President"})
create (_4:`Movie` {`name`:"WallStreet", `title`:"Wall Street"})
create (_5:`Person` {`name`:"Rob Reiner"})
create (_6:`Person` {`name`:"Michael Douglas"})
create _0-[:`DIRECTED`]-&gt;_4
create _1-[:`ACTED_IN`]-&gt;_4
create _1-[:`FATHER`]-&gt;_2
create _2-[:`ACTED_IN`]-&gt;_3
create _2-[:`ACTED_IN`]-&gt;_4
create _5-[:`DIRECTED`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_4
</span><span class="command"><strong>
 merge (keanu:Person {name:'Keanu Reeves'})
 on create set keanu.created = timestamp()
 on match set keanu.lastSeen = timestamp()
 return keanu</strong></span></p>
</section>
<section class="section" id="merge-merge-with-on-match-setting-multiple-properties"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge with ON MATCH setting multiple properties</h4></div></div></div>

<p>If multiple properties should be set, simply separate them with commas.</p>
<p><strong>Query </strong>
</p><pre class="programlisting" data-lang="cypher">MERGE (person:Person)
ON MATCH SET person.found = TRUE , person.lastAccessed = timestamp()
RETURN person</pre><p>
</p>
<div class="queryresult table" id="d5e10760"><p class="title"><strong>Result</strong></p><div class="queryresult table-contents"><table cellspacing="0" cellpadding="0"><thead><tr><th>person</th></tr></thead><tfoot><tr><th>5 rows
</th></tr><tr><th>Properties set: 10</th></tr></tfoot><tbody><tr><td><p><code class="literal">Node[0]{name:"Oliver Stone",found:true,lastAccessed:1423220759393}</code></p></td></tr><tr><td><p><code class="literal">Node[1]{name:"Charlie Sheen",found:true,lastAccessed:1423220759393}</code></p></td></tr><tr><td><p><code class="literal">Node[2]{name:"Martin Sheen",found:true,lastAccessed:1423220759393}</code></p></td></tr><tr><td><p><code class="literal">Node[5]{name:"Rob Reiner",found:true,lastAccessed:1423220759393}</code></p></td></tr><tr><td><p><code class="literal">Node[6]{name:"Michael Douglas",found:true,lastAccessed:1423220759393}</code></p></td></tr></tbody></table></div></div>
<p class="cypherconsole"><strong>Try this query live </strong><span class="database">create constraint on (n:`Person`) assert n.`name` is unique
create constraint on (n:`Person`) assert n.`role` is unique
create (_0:`Person` {`name`:"Oliver Stone"})
create (_1:`Person` {`name`:"Charlie Sheen"})
create (_2:`Person` {`name`:"Martin Sheen"})
create (_3:`Movie` {`name`:"TheAmericanPresident", `title`:"The American President"})
create (_4:`Movie` {`name`:"WallStreet", `title`:"Wall Street"})
create (_5:`Person` {`name`:"Rob Reiner"})
create (_6:`Person` {`name`:"Michael Douglas"})
create _0-[:`DIRECTED`]-&gt;_4
create _1-[:`ACTED_IN`]-&gt;_4
create _1-[:`FATHER`]-&gt;_2
create _2-[:`ACTED_IN`]-&gt;_3
create _2-[:`ACTED_IN`]-&gt;_4
create _5-[:`DIRECTED`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_4
</span><span class="command"><strong>
 merge (person:Person)
 on match set person.found = true, person.lastAccessed = timestamp()
 return person</strong></span></p>
</section>
</section>
<section class="section" id="_merge_relationships"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge relationships</h3></div></div></div>

<section class="section" id="merge-merge-on-a-relationship"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge on a relationship</h4></div></div></div>

<p><code class="literal">MERGE</code> can be used to match or create a relationship.</p>
<p><strong>Query </strong>
</p><pre class="programlisting" data-lang="cypher">MATCH (charlie:Person { name:'Charlie Sheen' }),(wallStreet:Movie { title:'Wall Street' })
MERGE (charlie)-[r:ACTED_IN]-&gt;(wallStreet)
RETURN r</pre><p>
</p>
<p>Charlie Sheen had already been marked as acting on Wall Street, so the existing relationship is found and returned. Note that in order to match or create a relationship when using <code class="literal">MERGE</code>, at least one bound node must be specified, which is done via the <code class="literal">MATCH</code> clause in the above example.</p>
<div class="queryresult table" id="d5e10811"><p class="title"><strong>Result</strong></p><div class="queryresult table-contents"><table cellspacing="0" cellpadding="0"><thead><tr><th>r</th></tr></thead><tfoot><tr><th>1 row</th></tr></tfoot><tbody><tr><td><p><code class="literal">:ACTED_IN[0]{}</code></p></td></tr></tbody></table></div></div>
<p class="cypherconsole"><strong>Try this query live </strong><span class="database">create constraint on (n:`Person`) assert n.`name` is unique
create constraint on (n:`Person`) assert n.`role` is unique
create (_0:`Person` {`name`:"Oliver Stone"})
create (_1:`Person` {`name`:"Charlie Sheen"})
create (_2:`Person` {`name`:"Martin Sheen"})
create (_3:`Movie` {`name`:"TheAmericanPresident", `title`:"The American President"})
create (_4:`Movie` {`name`:"WallStreet", `title`:"Wall Street"})
create (_5:`Person` {`name`:"Rob Reiner"})
create (_6:`Person` {`name`:"Michael Douglas"})
create _0-[:`DIRECTED`]-&gt;_4
create _1-[:`ACTED_IN`]-&gt;_4
create _1-[:`FATHER`]-&gt;_2
create _2-[:`ACTED_IN`]-&gt;_3
create _2-[:`ACTED_IN`]-&gt;_4
create _5-[:`DIRECTED`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_4
</span><span class="command"><strong>
 match (charlie:Person {name:'Charlie Sheen'}), (wallStreet:Movie {title:'Wall Street'})
 merge (charlie)-[r:ACTED_IN]-&gt;(wallStreet)
 return r</strong></span></p>
</section>
<section class="section" id="merge-merge-on-multiple-relationships"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge on multiple relationships</h4></div></div></div>

<p>When <code class="literal">MERGE</code> is used on a whole pattern, either everything matches, or everything is created.</p>
<p><strong>Query </strong>
</p><pre class="programlisting" data-lang="cypher">MATCH (oliver:Person { name:'Oliver Stone' }),(reiner:Person { name:'Rob Reiner' })
MERGE (oliver)-[:DIRECTED]-&gt;(movie:Movie)&lt;-[:ACTED_IN]-(reiner)
RETURN movie</pre><p>
</p>
<p>In our example graph, Oliver Stone and Rob Reiner have never worked together. When we try to <code class="literal">MERGE</code> a movie between them, Cypher will not use any of the existing movies already connected to either person. Instead, a new movie node is created.</p>
<div class="queryresult table" id="d5e10841"><p class="title"><strong>Result</strong></p><div class="queryresult table-contents"><table cellspacing="0" cellpadding="0"><thead><tr><th>movie</th></tr></thead><tfoot><tr><th>1 row
</th></tr><tr><th>Nodes created: 1
</th></tr><tr><th>Relationships created: 2
</th></tr><tr><th>Labels added: 1</th></tr></tfoot><tbody><tr><td><p><code class="literal">Node[7]{}</code></p></td></tr></tbody></table></div></div>
<p class="cypherconsole"><strong>Try this query live </strong><span class="database">create constraint on (n:`Person`) assert n.`name` is unique
create constraint on (n:`Person`) assert n.`role` is unique
create (_0:`Person` {`name`:"Oliver Stone"})
create (_1:`Person` {`name`:"Charlie Sheen"})
create (_2:`Person` {`name`:"Martin Sheen"})
create (_3:`Movie` {`name`:"TheAmericanPresident", `title`:"The American President"})
create (_4:`Movie` {`name`:"WallStreet", `title`:"Wall Street"})
create (_5:`Person` {`name`:"Rob Reiner"})
create (_6:`Person` {`name`:"Michael Douglas"})
create _0-[:`DIRECTED`]-&gt;_4
create _1-[:`ACTED_IN`]-&gt;_4
create _1-[:`FATHER`]-&gt;_2
create _2-[:`ACTED_IN`]-&gt;_3
create _2-[:`ACTED_IN`]-&gt;_4
create _5-[:`DIRECTED`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_4
</span><span class="command"><strong>
 match (oliver:Person {name:'Oliver Stone'}), (reiner:Person {name:'Rob Reiner'})
 merge (oliver)-[:DIRECTED]-&gt;(movie:Movie)&lt;-[:ACTED_IN]-(reiner)
 return movie</strong></span></p>
</section>
<section class="section" id="merge-merge-on-an-undirected-relationship"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge on an undirected relationship</h4></div></div></div>

<p><code class="literal">MERGE</code> can also be used with an undirected relationship. When it needs to create a new one, it will pick a direction.</p>
<p><strong>Query </strong>
</p><pre class="programlisting" data-lang="cypher">MATCH (charlie:Person { name:'Charlie Sheen' }),(oliver:Person { name:'Oliver Stone' })
MERGE (charlie)-[r:KNOWS]-(oliver)
RETURN r</pre><p>
</p>
<p>Assume that Charlie Sheen and Oliver Stone do not know each other then this <code class="literal">MERGE</code> query will create a <code class="literal">:KNOWS</code> relationship between them. The direction of the created relationship is arbitrary.</p>
<div class="queryresult table" id="d5e10878"><p class="title"><strong>Result</strong></p><div class="queryresult table-contents"><table cellspacing="0" cellpadding="0"><thead><tr><th>r</th></tr></thead><tfoot><tr><th>1 row
</th></tr><tr><th>Relationships created: 1</th></tr></tfoot><tbody><tr><td><p><code class="literal">:KNOWS[8]{}</code></p></td></tr></tbody></table></div></div>
<p class="cypherconsole"><strong>Try this query live </strong><span class="database">create constraint on (n:`Person`) assert n.`name` is unique
create constraint on (n:`Person`) assert n.`role` is unique
create (_0:`Person` {`name`:"Oliver Stone"})
create (_1:`Person` {`name`:"Charlie Sheen"})
create (_2:`Person` {`name`:"Martin Sheen"})
create (_3:`Movie` {`name`:"TheAmericanPresident", `title`:"The American President"})
create (_4:`Movie` {`name`:"WallStreet", `title`:"Wall Street"})
create (_5:`Person` {`name`:"Rob Reiner"})
create (_6:`Person` {`name`:"Michael Douglas"})
create _0-[:`DIRECTED`]-&gt;_4
create _1-[:`ACTED_IN`]-&gt;_4
create _1-[:`FATHER`]-&gt;_2
create _2-[:`ACTED_IN`]-&gt;_3
create _2-[:`ACTED_IN`]-&gt;_4
create _5-[:`DIRECTED`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_4
</span><span class="command"><strong>
 match (charlie:Person {name:'Charlie Sheen'}), (oliver:Person {name:'Oliver Stone'})
 merge (charlie)-[r:KNOWS]-(oliver)
 return r</strong></span></p>
</section>
</section>
<section class="section" id="_using_unique_constraints_with_merge"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Using unique constraints with MERGE</h3></div></div></div>

<p>Cypher prevents getting conflicting results from <code class="literal">MERGE</code> when using patterns that involve uniqueness constrains.
In this case, there must be at most one node that matches that pattern.</p>
<p>For example, given two uniqueness constraints on <code class="literal">:Person(id)</code> and <code class="literal">:Person(ssn)</code>: then a query such as <code class="literal">MERGE (n:Person {id: 12, ssn: 437})</code> will fail, if there are two different nodes (one with <code class="literal">id</code> 12 and one with <code class="literal">ssn</code> 437) or if there is only one node with only one of the properties.
In other words, there must be exactly one node that matches the pattern, or no matching nodes.</p>
<p>Note that the following examples assume the existence of uniqueness constraints that have been created using:</p>
<pre class="programlisting" data-lang="cypher">CREATE CONSTRAINT ON (n:Person) ASSERT n.name IS UNIQUE;
CREATE CONSTRAINT ON (n:Person) ASSERT n.role IS UNIQUE;</pre>
<section class="section" id="merge-merge-using-unique-constraints-creates-a-new-node-if-no-node-is-found"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge using unique constraints creates a new node if no node is found</h4></div></div></div>

<p>Merge using unique constraints creates a new node if no node is found.</p>
<p><strong>Query </strong>
</p><pre class="programlisting" data-lang="cypher">MERGE (laurence:Person { name: 'Laurence Fishburne' })
RETURN laurence</pre><p>
</p>
<p>The query creates the laurence node. If laurence already existed, merge would just return the existing node.</p>
<div class="queryresult table" id="d5e10920"><p class="title"><strong>Result</strong></p><div class="queryresult table-contents"><table cellspacing="0" cellpadding="0"><thead><tr><th>laurence</th></tr></thead><tfoot><tr><th>1 row
</th></tr><tr><th>Nodes created: 1
</th></tr><tr><th>Properties set: 1
</th></tr><tr><th>Labels added: 1</th></tr></tfoot><tbody><tr><td><p><code class="literal">Node[7]{name:"Laurence Fishburne"}</code></p></td></tr></tbody></table></div></div>
<p class="cypherconsole"><strong>Try this query live </strong><span class="database">create constraint on (n:`Person`) assert n.`name` is unique
create constraint on (n:`Person`) assert n.`role` is unique
create (_0:`Person` {`name`:"Oliver Stone"})
create (_1:`Person` {`name`:"Charlie Sheen"})
create (_2:`Person` {`name`:"Martin Sheen"})
create (_3:`Movie` {`name`:"TheAmericanPresident", `title`:"The American President"})
create (_4:`Movie` {`name`:"WallStreet", `title`:"Wall Street"})
create (_5:`Person` {`name`:"Rob Reiner"})
create (_6:`Person` {`name`:"Michael Douglas"})
create _0-[:`DIRECTED`]-&gt;_4
create _1-[:`ACTED_IN`]-&gt;_4
create _1-[:`FATHER`]-&gt;_2
create _2-[:`ACTED_IN`]-&gt;_3
create _2-[:`ACTED_IN`]-&gt;_4
create _5-[:`DIRECTED`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_4
</span><span class="command"><strong>
 merge (laurence:Person {name: 'Laurence Fishburne'}) return laurence</strong></span></p>
</section>
<section class="section" id="merge-merge-using-unique-constraints-matches-an-existing-node"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge using unique constraints matches an existing node</h4></div></div></div>

<p>Merge using unique constraints matches an existing node.</p>
<p><strong>Query </strong>
</p><pre class="programlisting" data-lang="cypher">MERGE (oliver:Person { name:'Oliver Stone' })
RETURN oliver</pre><p>
</p>
<p>The oliver node already exists, so merge just returns it.</p>
<div class="queryresult table" id="d5e10954"><p class="title"><strong>Result</strong></p><div class="queryresult table-contents"><table cellspacing="0" cellpadding="0"><thead><tr><th>oliver</th></tr></thead><tfoot><tr><th>1 row</th></tr></tfoot><tbody><tr><td><p><code class="literal">Node[0]{name:"Oliver Stone"}</code></p></td></tr></tbody></table></div></div>
<p class="cypherconsole"><strong>Try this query live </strong><span class="database">create constraint on (n:`Person`) assert n.`name` is unique
create constraint on (n:`Person`) assert n.`role` is unique
create (_0:`Person` {`name`:"Oliver Stone"})
create (_1:`Person` {`name`:"Charlie Sheen"})
create (_2:`Person` {`name`:"Martin Sheen"})
create (_3:`Movie` {`name`:"TheAmericanPresident", `title`:"The American President"})
create (_4:`Movie` {`name`:"WallStreet", `title`:"Wall Street"})
create (_5:`Person` {`name`:"Rob Reiner"})
create (_6:`Person` {`name`:"Michael Douglas"})
create _0-[:`DIRECTED`]-&gt;_4
create _1-[:`ACTED_IN`]-&gt;_4
create _1-[:`FATHER`]-&gt;_2
create _2-[:`ACTED_IN`]-&gt;_3
create _2-[:`ACTED_IN`]-&gt;_4
create _5-[:`DIRECTED`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_3
create _6-[:`ACTED_IN`]-&gt;_4
</span><span class="command"><strong>
 merge (oliver:Person {name:'Oliver Stone'}) return oliver</strong></span></p>
</section>
<section class="section" id="merge-merge-with-unique-constraints-and-partial-matches"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge with unique constraints and partial matches</h4></div></div></div>

<p>Merge using unique constraints fails when finding partial matches.</p>
<p><strong>Query </strong>
</p><pre class="programlisting" data-lang="cypher">MERGE (michael:Person { name:'Michael Douglas', role:'Gordon Gekko' })
RETURN michael</pre><p>
</p>
<p>While there is a matching unique michael node with the name <span class="emphasis"><em>Michael Douglas</em></span>, there is no unique node with the role of <span class="emphasis"><em>Gordon Gekko</em></span> and merge fails to match.</p>
<p><strong>Error message </strong>
</p><pre class="programlisting" data-lang="plain">Merge did not find a matching node and can not create a new node due to conflicts
with both existing and missing unique nodes. The conflicting constraints are on:
:Person.name and :Person.role</pre><p>
</p>
</section>
<section class="section" id="merge-merge-with-unique-constraints-and-conflicting-matches"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Merge with unique constraints and conflicting matches</h4></div></div></div>

<p>Merge using unique constraints fails when finding conflicting matches.</p>
<p><strong>Query </strong>
</p><pre class="programlisting" data-lang="cypher">MERGE (oliver:Person { name:'Oliver Stone', role:'Gordon Gekko' })
RETURN oliver</pre><p>
</p>
<p>While there is a matching unique oliver node with the name <span class="emphasis"><em>Oliver Stone</em></span>, there is also another unique node with the role of <span class="emphasis"><em>Gordon Gekko</em></span> and merge fails to match.</p>
<p><strong>Error message </strong>
</p><pre class="programlisting" data-lang="plain">Merge did not find a matching node and can not create a new node due to conflicts
with both existing and missing unique nodes. The conflicting constraints are on:
:Person.name and :Person.role</pre><p>
</p>
</section>
</section>
<section class="section" id="merge-using-map-parameters-with-merge"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Using map parameters with MERGE</h3></div></div></div>

<p><code class="literal">MERGE</code> does not support map parameters like for example <code class="literal">CREATE</code> does.
To use map parameters with <code class="literal">MERGE</code>, it is necessary to explicitly use the expected properties, like in the following example.
For more information on parameters, see <a class="xref" href="cypher-parameters.html" title="8.5. Parameters">Section 8.5, “Parameters”</a>.</p>
<p><strong>Parameters </strong>
</p><pre class="programlisting" data-lang="javascript">{
  "param" : {
    "name" : "Keanu Reeves",
    "role" : "Neo"
  }
}</pre><p>
</p>
<p><strong>Query </strong>
</p><pre class="programlisting" data-lang="cypher">MERGE (oliver:Person { name: { param }.name, role: { param }.role })
RETURN oliver</pre><p>
</p>
<div class="queryresult table" id="d5e11017"><p class="title"><strong>Result</strong></p><div class="queryresult table-contents"><table cellspacing="0" cellpadding="0"><thead><tr><th>oliver</th></tr></thead><tfoot><tr><th>1 row
</th></tr><tr><th>Nodes created: 1
</th></tr><tr><th>Properties set: 2
</th></tr><tr><th>Labels added: 1</th></tr></tfoot><tbody><tr><td><p><code class="literal">Node[7]{name:"Keanu Reeves",role:"Neo"}</code></p></td></tr></tbody></table></div></div>
</section>
</section>

 <footer>
   <p>
   © Copyright
   <a href="http://creativecommons.org/licenses/by-sa/3.0/"><img id="copyright-img" src="images/by-sa.svg" alt="CC BY-SA 3.0" title="Creative Commons Attribution-ShareAlike 3.0"></a>
   <a href="http://neo4j.com/"><img id="neotech-logo" src="images/neo-technology.svg" alt="Neo Technology"></a>
   </p>
 </footer>
  <script type="text/javascript">

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    //Allow Linker
    ga('create', 'UA-1192232-34','auto', {'allowLinker': true});
    ga('send', 'pageview');

    // Load the plugin.
    ga('require', 'linker');

    // Define which domains to autoLink.
    ga('linker:autoLink', ['neo4j.org','neo4j.com','neotechnology.com','graphdatabases.com','graphconnect.com']);
  </script>

</div></body></html>