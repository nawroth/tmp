<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>24.4. Performance Guide -  - The Neo4j Manual v2.3-SNAPSHOT</title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="prev" href="server-performance.html" title="24.3. Server Performance Tuning" /><link rel="next" href="configuration-logical-logs.html" title="24.5. Logical logs" /><link rel="copyright" href="ln-d5e39.html" title="License: Creative Commons 3.0" /><meta name="Section-title" content="24.4. Performance Guide" /><script type="text/javascript">
      //The id for tree cookie
      var treeCookieId = "treeview-73202";
      var language = "en";
      var w = new Object();
      //Localization
      txt_filesfound = 'Results';
      txt_enter_at_least_1_char = "You must enter at least one character.";
      txt_browser_not_supported = "JavaScript is disabled on your browser. Please enable JavaScript to enjoy all the features of this site.";
      txt_please_wait = "Please wait. Search in progress...";
      txt_results_for = "Results for: ";
    </script><meta name="viewport" content="width=device-width, initial-scale=1" /><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" /><link rel="stylesheet" type="text/css" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/redmond/jquery-ui.min.css" /><link rel="stylesheet" type="text/css" href="common/jquery/treeview/jquery.treeview.css" /><link rel="stylesheet" type="text/css" href="common/css/positioning.css" /><link rel="stylesheet" type="text/css" href="common/css/style.css" /><!--[if IE]>
  <link rel="stylesheet" type="text/css" href="../common/css/ie.css"/>
  <![endif]--><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" /><script type="text/javascript" src="common/browserDetect.js"></script><script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script><script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script><script type="text/javascript" src="common/jquery/jquery.highlight.js"></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script><script type="text/javascript" src="common/jquery/treeview/jquery.treeview.min.js"></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-scrollTo/2.1.1/jquery.scrollTo.min.js"></script><script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script><script type="text/javascript" src="common/main.js"></script><script type="text/javascript" src="search/l10n.js"></script><script type="text/javascript" src="search/htmlFileInfoList.js"></script><script type="text/javascript" src="common/search.js"></script><script type="text/javascript" src="search/stemmers/en_stemmer.js"></script><script type="text/javascript" src="search/index-1.js"></script><script type="text/javascript" src="search/index-2.js"></script><script type="text/javascript" src="search/index-3.js"></script>


<!-- favicon -->

<link rel="shortcut icon" href="common/images/favicon.ico" />

<!-- fonts -->

<link href='//fonts.googleapis.com/css?family=Ubuntu+Mono|PT+Sans:400,700,400italic' rel='stylesheet' type='text/css' />

<!-- Syntax Highlighter -->

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.6.0/codemirror.min.css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.6.0/theme/neo.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.6.0/codemirror.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.6.0/addon/runmode/runmode.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.6.0/mode/javascript/javascript.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.6.0/mode/shell/shell.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.6.0/mode/sql/sql.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.6.0/mode/xml/xml.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.6.0/mode/clike/clike.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.6.0/mode/cypher/cypher.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.6.0/mode/properties/properties.min.js"></script>

<script src="js/colorize.js"></script>
 
<script type="text/javascript">
  $(function (){
    CodeMirror.colorize();
  });
</script>

<!-- Section table of contents -->

<script type="text/javascript" src="js/toc.js"></script>

<!-- Cypher Console -->

<script type="text/javascript" src="js/console.js"></script>
<script type="text/javascript" src="js/cypherconsole.js"></script>

<!-- Version -->
<script type="text/javascript" src="js/version.js"></script>
<script type="text/javascript" src="js/versionswitcher.js"></script>

<!-- Discuss -->
<script type="text/javascript" src="js/mutate.min.js"></script>
<script type="text/javascript" src="js/disqus.js"></script>

<script type="text/javascript">
    /*@cc_on @*/
    /*@
     $( '#content' ).addClass( 'internet-explorer' );
     @*/
</script>


</head><body><div id="header"><a href="index.html" id="logo"><img src="common/images/logo-neo4j.svg" alt="" /></a><h1><span id="book-title">The Neo4j Manual v2.3-SNAPSHOT</span><span>24.4. Performance Guide</span></h1><div id="navheader"><!----><div id="navLinks"><span><a id="showHideButton" href="#" class="pointLeft" tabindex="5" title="Show/Hide TOC tree"><i class="fa fa-columns"></i> Contents
            </a></span><span><a accesskey="p" id="navLinkPrevious" tabindex="5" href="server-performance.html"><i class="fa fa-arrow-circle-left"></i> Prev</a></span><span><a accesskey="u" id="navLinkUp" tabindex="5" href="configuration.html">Up <i class="fa fa-arrow-circle-up"></i></a></span><span><a accesskey="n" id="navLinkNext" tabindex="5" href="configuration-logical-logs.html">Next <i class="fa fa-arrow-circle-right"></i></a></span></div></div></div><div id="content"><section class="section" id="performance-guide"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both">24.4. Performance Guide</h2></div></div></div><div class="toc"><ul class="toc"><li><span class="section"><a href="performance-guide.html#_try_this_first">Try this first</a></span></li><li><span class="section"><a href="performance-guide.html#_configuring_heap_size_and_gc">Configuring heap size and GC</a></span></li><li><span class="section"><a href="performance-guide.html#_disks_ram_and_other_tips">Disks, RAM and other tips</a></span></li><li><span class="section"><a href="performance-guide.html#_linux_file_system_tuning">Linux file system tuning</a></span></li><li><span class="section"><a href="performance-guide.html#_setting_the_number_of_open_files">Setting the number of open files</a></span></li></ul></div>

<p>This is the Neo4j performance guide. It will attempt to give you guidance on how to tune Neo4j to achieve maximum performance.</p>
<section class="section" id="_try_this_first"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Try this first</h3></div></div></div>

<p>The first thing to look at, when Neo4j is not performing as expected, is to make sure that your Cypher queries do not do more work than they have to.
For instance, a query might, unbeknownst to the author, mandate the production of a large cartesian product; or it might perform an expensive label-scan, because a certain label/property combination isn’t indexed.
The <a class="xref" href="query-tuning.html" title="Chapter 15. Query Tuning">Chapter 15, <em>Query Tuning</em></a> chapter has more information on how to investigate Cypher performance issues.</p>
<p>The second thing to look at, is to make sure that the Neo4j Java process has enough memory to do its work.
If there is not enough memory to keep the JVM heap resident, then the OS will swap it out to storage.
When a garbage collection happens, the swapped out heap memory has to be swapped in again, and something else will have to be swapped out.
This swap-thrashing effect has a dramatic impact on the performance of the database, rendering it practically unusable.
A well-tuned Neo4j database should not have any swap activity in its steady-state.</p>
<p>Next, make sure the JVM has enough memory, and isn’t spending too much time in garbage collection.
The goal is to have a large enough heap so heavy/peak load will not result in so called GC-trashing.
Performance can drop as much as two orders of a magnitude when GC-thrashing happens.</p>
<p>Start the JVM with <code class="literal">-server</code> flag and <code class="literal">-Xmx&lt;good sized heap&gt;</code>, f.ex. <code class="literal">-Xmx512m</code> for 512 MiB memory or <code class="literal">-Xmx3g</code> for 3GiB memory.
Having too large heap may also hurt performance so you may have to try out some different heap sizes.
Make sure you are using a concurrent garbage collector.
We find that <code class="literal">-XX:+UseG1GC</code> works well in most use-cases.</p>
<p>The next thing to look at, is the file caching memory.
Neo4j uses its own page cache for the store files, and relies on the operating system for caching the index files.
Make sure that the <code class="literal">dbms.pagecache.memory</code> setting (in <span class="emphasis"><em>neo4j.properties</em></span>) is large enough to fit the entire store, if possible.
But also make sure that you are not allocating so much memory to the JVM and the Neo4j page cache, that there is no memory left for the operating system to cache the Lucene index files.
For more information on configuration see <a class="xref" href="configuration.html" title="Chapter 24. Configuration &amp; Performance">Chapter 24, <em>Configuration &amp; Performance</em></a>.</p>
</section>
<section class="section" id="_configuring_heap_size_and_gc"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Configuring heap size and GC</h3></div></div></div>

<p>The size of the JVM heap is an important aspect of the performance of any Java application.
The heap is separated into an old generation and a young generation.
New objects are allocated in the young generation, and then later moved to the old generation if they stay live (in use) for long enough.
When a generation fills up, the garbage collector performs a collection, during which all other threads in the process are paused.
The young generation is quick to collect since the pause time correlates with the <span class="emphasis"><em>live set</em></span> of objects, and is independent of the size of the young generation.
In the old generation, pause times roughly correlates with the size of the heap.
For this reason, the heap should ideally be sized and tuned such that transaction and query state never makes it to the old generation.</p>
<div class="admonitionblock Note"><table><tr><td class="icon"><img alt="[Note]" src="images/icons/admon/note.svg" /></td><td class="content"><b>Note</b><p>When using Neo4j Server, JVM configuration goes into the <span class="emphasis"><em>conf/neo4j-wrapper.conf</em></span> file, see <a class="xref" href="server-configuration.html" title="24.2. Server Configuration">Section 24.2, “Server Configuration”</a>.</p></td></tr></table></div>
<p>In server deployments, the heap size is configured with the <code class="literal">wrapper.java.maxmemory</code> (in MBs) setting in the <span class="emphasis"><em>neo4j-wrapper.conf</em></span> file.
For embedded, you specify the heap size by giving the <code class="literal">-Xmx???m</code> command line flag to the <code class="literal">java</code> process, where the <code class="literal">???</code> is the maximum heap size in MBs.
The initial size of the heap is specified by the <code class="literal">wrapper.java.initmemory</code> setting, or with the <code class="literal">-Xms???m</code> flag, or chosen heuristically by the JVM itself if left unspecified.
The JVM will automatically grow the heap as needed, up to the maximum size.
The growing of the heap requires a full GC cycle, so if you know that you will need all the heap memory, you can set the initial heap size and the maximum heap size to the same value, and avoid the GC pauses that would otherwise be required to grow the heap.</p>
<div class="table" id="d5e21702"><p class="title"><strong>Guidelines for heap size</strong></p><div class="table-contents">




<table cellspacing="0" cellpadding="0"><thead><tr><th>Number of entities</th><th>RAM size</th><th>Heap configuration</th><th>Reserved RAM for the OS</th></tr></thead><tbody><tr><td><p>10M</p></td><td><p>2GB</p></td><td><p>512MB</p></td><td><p>~1GB</p></td></tr><tr><td><p>100M</p></td><td><p>8GB+</p></td><td><p>1-4GB</p></td><td><p>1-2GB</p></td></tr><tr><td><p>1B+</p></td><td><p>16GB-32GB+</p></td><td><p>4GB+</p></td><td><p>1-2GB</p></td></tr></tbody></table>
</div></div>
<p>The ratio of the size between the old generation and the new generation of the heap, is controlled by the <code class="literal">-XX:NewRatio=N</code> flag, where <code class="literal">N</code> is typically between 2 and 8 by default.
A ratio of 2 means that the old generation size, divided by the new generation size, is equal to 2.
In other words, two thirds of the heap memory will be dedicated to the old generation.
A ratio of 3 will dedicate three quarters of the heap to the old generation, and a ratio of 1 will keep the two generations about the same size.
A ratio of 1 is quite aggressive, but may be necessary if your transactions changes a lot of data.
Having a large new generation can also be important if you run Cypher queries that needs to keep a lot of data resident, e.g. for sorting big result sets.</p>
<p>If the new generation is too small, short-lived objects might be moved to the old generation too soon.
This is called premature promotion, and will slow the database down by increasing the frequency of old generation GC cycles.
If the new generation is too big, the GC might decide that the old generation does not have enough space to fit all the objects it expects to promote from the new to the old generation.
This turns new generation GC cycles into old generation GC cycles, again slowing the database down.
Running more concurrent threads means that more allocations can take place in a given span of time, in turn increasing the pressure on the new generation in particular.</p>
<p>Be aware that configuring a heap size larger than 32 GiBs will disable a feature in the JVM called Compressed OOPs.
When the heap size is less than 32 GiBs, the JVM can compress object references to only use 32 bits.
This saves a lot of heap memory, and means that the gains from a larger heap are small or even negative, if you cannot give it at least 64 GiBs.</p>
<p>Neo4j has a number of long-lived objects, that stay around in the old generation, effectively for the lifetime of the Java process.
To process them efficiently, and without adversely affecting the GC pause time, we recommend using a concurrent garbage collector.</p>
<div class="admonitionblock Tip"><table><tr><td class="icon"><img alt="[Tip]" src="images/icons/admon/tip.svg" /></td><td class="content"><b>Tip</b><p>The recommended garbage collector to use when running Neo4j in production is the G1 garbage collector.
G1 is turned on by default in server deployments.
For embedded deployments, it can be turned on by supplying <code class="literal">-XX:+UseG1GC</code> as a JVM parameter.</p></td></tr></table></div>
<p>Tuning the specific GC algorithm depends on both the JVM version and the workload.
It is recommended that you test your GC settings under realistic load for days or weeks.
Problems like heap fragmentation can take a long time to surface.</p>
</section>
<section class="section" id="_disks_ram_and_other_tips"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Disks, RAM and other tips</h3></div></div></div>

<p>As always, as with any persistence solution, performance depends a lot on the persistence media used.
Better disks equals better performance.</p>
<p>If you have multiple disks or persistence media available it may be a good idea to split the store files and transaction logs across those disks.
Having the store files running on disks with low seek time can do wonders for read operations.
Today a typical mechanical drive has an average seek time of about 5ms.
This can cause a query or traversal to be very slow when the amount of RAM assigned to the page cache is too small.
A new good SATA enabled SSD has an average seek time of less than 100 microseconds, meaning those scenarios will execute at least 50 times faster.
However, this is still tens or hundreds of times slower than accessing RAM.</p>
<p>To avoid hitting disk you need more RAM.
On a standard mechanical drive you can handle graphs with a few tens of millions of primitives (nodes, relationships and properties) with 2-3 GBs of RAM.
A server with 8-16 GBs of RAM can handle graphs with hundreds of millions of primitives, and a good server with 16-64 GBs can handle billions of primitives.
However, if you invest in a good SSD you will be able to handle much larger graphs on less RAM.</p>
<p>Use tools like <code class="literal">dstat</code> or <code class="literal">vmstat</code> to gather information when your application is running.
If the swap or paging numbers are high, then its a sign that the Lucene indexes don’t quite fit in memory.
In this case, queries that do index lookups will have high latencies.</p>
<p>When Neo4j starts up, its page cache is empty and needs to warm up.
This can take a while, especially for large stores, so it’s not uncommon to see a long period with many blocks being read from the drive, and high IO wait times.</p>
<p>Neo4j also flushes its page cache in the background, so it is not uncommon to see a steady trickle of blocks being written to the drive, during steady-state.
This background flushing only produces a small amount of IO wait, however.
If the IO wait times are high during steady-state, then it might be a sign that Neo4j is bottle-necked on the random IO performance of the drive.
The best drives for running Neo4j are fast SSDs that can take lots of random IOPS.</p>
</section>
<section class="section" id="_linux_file_system_tuning"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Linux file system tuning</h3></div></div></div>

<p>Databases often produce many small and random reads when querying data, and few sequential writes when committing changes.
Neo4j is no different in this regard.</p>
<p>By default, most Linux distributions schedules IO requests using the Completely Fair Queuing (CFQ) algorithm, which provides a good balance between throughput and latency.
The particular IO workload of a database, however, is better served by the Deadline scheduler.
The Deadline scheduler gives preference to <span class="emphasis"><em>read</em></span> requests, and processes them as soon as possible.
This tends to decrease the latency of reads, while the latency of writes goes up.
Since the writes are usually sequential, their lingering in the IO queue increases the change of overlapping or adjacent write requests being merged together.
This effectively reduces the number of writes that are sent to the drive.</p>
<p>On Linux, the IO scheduler for a drive, in this case <code class="literal">sda</code>, can be changed at runtime like this:</p>
<pre class="programlisting" data-lang="shell">$ echo 'deadline' &gt; /sys/block/sda/queue/scheduler
$ cat               /sys/block/sda/queue/scheduler
noop [deadline] cfq</pre>
<p>Another recommended practice is to disable file and directory access time updates.
This way, the file system won’t have to issue writes that update this meta-data, thus improving write performance.
You do this by setting the <code class="literal">noatime,nodiratime</code> mount options in your <span class="emphasis"><em>fstab</em></span>, or when you issue your disk mount command.</p>
<p>There may be other tuning options relevant to your specific file system of choice, but make sure that barriers are enabled.
Barriers prevent certain reorderings of writes.
They are important for maintaining the integrity of the transaction log, in case a power failure happens.</p>
</section>
<section class="section" id="_setting_the_number_of_open_files"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Setting the number of open files</h3></div></div></div>

<p>Linux platforms impose an upper limit on the number of concurrent files a user may have open.
This number is reported for the current user and session with the <code class="literal">ulimit -n</code> command:</p>
<pre class="programlisting" data-lang="shell">user@localhost:~$ ulimit -n
1024</pre>
<p>The usual default of 1024 is often not enough, especially when many indexes are used or a server installation sees too many connections — network sockets count against that limit as well.
Users are therefore encouraged to increase that limit to a healthy value of 40000 or more, depending on usage patterns.
Setting this value via the <code class="literal">ulimit</code> command is possible only for the root user and that for that session only.
To set the value system wide you have to follow the instructions for your platform.</p>
<p>What follows is the procedure to set the open file descriptor limit to 40k for user neo4j under Ubuntu 10.04 and later.
If you opted to run the neo4j service as a different user, change the first field in step 2 accordingly.</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<p class="simpara">
Become root since all operations that follow require editing protected system files.
</p>
<pre class="programlisting" data-lang="shell">user@localhost:~$ sudo su -
Password:
root@localhost:~$</pre>
</li><li class="listitem">
<p class="simpara">
Edit <code class="literal">/etc/security/limits.conf</code> and add these two lines:
</p>
<pre class="programlisting" data-lang="shell">neo4j   soft    nofile  40000
neo4j   hard    nofile  40000</pre>
</li><li class="listitem">
<p class="simpara">
Edit <code class="literal">/etc/pam.d/su</code> and uncomment or add the following line:
</p>
<pre class="programlisting" data-lang="shell">session    required   pam_limits.so</pre>
</li><li class="listitem">
<p class="simpara">
A restart is required for the settings to take effect.
</p>
<p class="simpara">After the above procedure, the neo4j user will have a limit of 40000 simultaneous open files.
If you continue experiencing exceptions on <code class="literal">Too many open files</code> or <code class="literal">Could not stat() directory</code> then you may have to raise that limit further.</p>
</li></ol></div>
</section>
</section>

 <footer>
   <p>
   © Copyright
   <a href="http://creativecommons.org/licenses/by-sa/3.0/"><img id="copyright-img" src="images/by-sa.svg" alt="CC BY-SA 3.0" title="Creative Commons Attribution-ShareAlike 3.0"></a>
   <a href="http://neo4j.com/"><img id="neotech-logo" src="images/neo-technology.svg" alt="Neo Technology"></a>
   </p>
 </footer>
  <script type="text/javascript">

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    //Allow Linker
    ga('create', 'UA-1192232-34','auto', {'allowLinker': true});
    ga('send', 'pageview');

    // Load the plugin.
    ga('require', 'linker');

    // Define which domains to autoLink.
    ga('linker:autoLink', ['neo4j.org','neo4j.com','neotechnology.com','graphdatabases.com','graphconnect.com']);
  </script>

</div></body></html>