<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>24.4. Performance Guide -  - The Neo4j Manual v2.2-SNAPSHOT</title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="prev" href="server-performance.html" title="24.3. Server Performance Tuning" /><link rel="next" href="configuration-settings.html" title="24.5. Configuration Settings" /><link rel="copyright" href="ln-d5e39.html" title="License: Creative Commons 3.0" /><meta name="Section-title" content="24.4. Performance Guide" /><script type="text/javascript">
      //The id for tree cookie
      var treeCookieId = "treeview-71024";
      var language = "en";
      var w = new Object();
      //Localization
      txt_filesfound = 'Results';
      txt_enter_at_least_1_char = "You must enter at least one character.";
      txt_browser_not_supported = "JavaScript is disabled on your browser. Please enable JavaScript to enjoy all the features of this site.";
      txt_please_wait = "Please wait. Search in progress...";
      txt_results_for = "Results for: ";
    </script><meta name="viewport" content="width=device-width, initial-scale=1" /><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" /><link rel="stylesheet" type="text/css" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/themes/redmond/jquery-ui.min.css" /><link rel="stylesheet" type="text/css" href="common/jquery/treeview/jquery.treeview.css" /><link rel="stylesheet" type="text/css" href="common/css/positioning.css" /><link rel="stylesheet" type="text/css" href="common/css/style.css" /><!--[if IE]>
  <link rel="stylesheet" type="text/css" href="../common/css/ie.css"/>
  <![endif]--><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" /><script type="text/javascript" src="common/browserDetect.js"></script><script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script><script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js"></script><script type="text/javascript" src="common/jquery/jquery.highlight.js"></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script><script type="text/javascript" src="common/jquery/treeview/jquery.treeview.min.js"></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-scrollTo/1.4.11/jquery.scrollTo.min.js"></script><script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script><script type="text/javascript" src="common/main.js"></script><script type="text/javascript" src="search/l10n.js"></script><script type="text/javascript" src="search/htmlFileInfoList.js"></script><script type="text/javascript" src="common/search.js"></script><script type="text/javascript" src="search/stemmers/en_stemmer.js"></script><script type="text/javascript" src="search/index-1.js"></script><script type="text/javascript" src="search/index-2.js"></script><script type="text/javascript" src="search/index-3.js"></script>


<!-- favicon -->

<link rel="shortcut icon" href="common/images/favicon.ico" />

<!-- fonts -->

<link href='//fonts.googleapis.com/css?family=Ubuntu+Mono|PT+Sans:400,700,400italic' rel='stylesheet' type='text/css' />

<!-- Syntax Highlighter -->

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/codemirror.min.css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/theme/neo.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/codemirror.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/addon/runmode/runmode.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/mode/javascript/javascript.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/mode/shell/shell.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/mode/sql/sql.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/mode/xml/xml.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/mode/clike/clike.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/mode/cypher/cypher.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.6.0/mode/properties/properties.min.js"></script>

<script src="js/colorize.js"></script>
 
<script type="text/javascript">
  $(function (){
    CodeMirror.colorize();
  });
</script>

<!-- Cypher Console -->

<script type="text/javascript" src="js/console.js"></script>
<script type="text/javascript" src="js/cypherconsole.js"></script>

<!-- Version -->
<script type="text/javascript" src="js/version.js"></script>
<script type="text/javascript" src="js/versionswitcher.js"></script>

<!-- Discuss -->
<script type="text/javascript" src="js/mutate.min.js"></script>
<script type="text/javascript" src="js/disqus.js"></script>

<script type="text/javascript">
    /*@cc_on @*/
    /*@
     $( '#content' ).addClass( 'internet-explorer' );
     @*/
</script>


</head><body><div id="header"><a href="index.html" id="logo"><img src="common/images/logo-neo4j.svg" alt="" /></a><h1><span id="book-title">The Neo4j Manual v2.2-SNAPSHOT</span><span>24.4. Performance Guide</span></h1><div id="navheader"><!----><div id="navLinks"><span><a id="showHideButton" href="#" class="pointLeft" tabindex="5" title="Show/Hide TOC tree"><i class="fa fa-columns"></i> Contents
            </a></span><span><a accesskey="p" id="navLinkPrevious" tabindex="5" href="server-performance.html"><i class="fa fa-arrow-circle-left"></i> Prev</a></span><span><a accesskey="u" id="navLinkUp" tabindex="5" href="configuration.html">Up <i class="fa fa-arrow-circle-up"></i></a></span><span><a accesskey="n" id="navLinkNext" tabindex="5" href="configuration-settings.html">Next <i class="fa fa-arrow-circle-right"></i></a></span></div></div></div><div id="content"><section class="section" id="performance-guide"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both">24.4. Performance Guide</h2></div></div></div><div class="toc"><ul class="toc"><li><span class="section"><a href="performance-guide.html#_try_this_first">Try this first</a></span></li><li><span class="section"><a href="performance-guide.html#_neo4j_primitives_lifecycle">Neo4j primitives' lifecycle</a></span></li><li><span class="section"><a href="performance-guide.html#_configuring_neo4j">Configuring Neo4j</a></span></li></ul></div>

<p>This is the Neo4j performance guide. It will attempt to give you guidance on how to use Neo4j to achieve maximum performance.</p>
<section class="section" id="_try_this_first"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Try this first</h3></div></div></div>

<p>The first thing is to make sure the JVM is running well and not spending too much
time in garbage collection. Monitoring heap usage of an application that uses Neo4j
can be a bit confusing since Neo4j will increase the size of caches if there is
available memory and decrease if the heap is getting full. The goal is to have a
large enough heap so heavy/peak load will not result in so called GC trashing
(performance can drop as much as two orders of a magnitude when this happens).</p>
<p>Start the JVM with <code class="literal">-server</code> flag and <code class="literal">-Xmx&lt;good sized heap&gt;</code>
(f.ex. -Xmx512M for 512Mb memory or -Xmx3G for 3Gb memory). Having too large heap
may also hurt performance so you may have to try out some different heap sizes.
Make sure a parallel/concurrent garbage collector is running (<code class="literal">-XX:+UseConcMarkSweepGC</code> works well in most use-cases).</p>
<p>Finally make sure that the OS has some memory left to manage proper file system
caches. This means, if your server has 8GB of RAM don’t use all of that RAM for
heap (unless you have turned off memory mapped buffers), but leave a good part of it to the OS.
For more information on configuration see <a class="xref" href="configuration.html" title="Chapter 24. Configuration &amp; Performance">Chapter 24, <em>Configuration &amp; Performance</em></a>.</p>
<p>For Linux specific tweaks, see <a class="xref" href="linux-performance-guide.html" title="24.12. Linux Performance Guide">Section 24.12, “Linux Performance Guide”</a>.</p>
</section>
<section class="section" id="_neo4j_primitives_lifecycle"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Neo4j primitives' lifecycle</h3></div></div></div>

<p>Neo4j manages its primitives (nodes, relationships and properties)
different depending on how you use Neo4j. For example if you never get a
property from a certain node or relationship that node or relationship will
not have its properties loaded into memory. The first time, after loading a node or relationship,
that any property is accessed all the properties are loaded for that entity. If any of those properties
contain an array larger than a few elements or a long string such values are loaded
on demand when requesting them individually. Similarly, relationships of a node will
only be loaded the first time they are requested for that node.</p>
<p>Nodes and relationships are cached using LRU caches. If you (for some strange reason)
only work with nodes the relationship cache will become smaller and smaller while the
node cache is allowed to grow (if needed). Working with many relationships and few nodes
results in a bigger relationship cache and smaller node cache.</p>
<p>The Neo4j API specification does not say anything about order regarding
relationships so invoking <code class="literal">Node.getRelationships()</code>
may return the relationships in a different order than the previous invocation.
This allows us to make even heavier optimizations returning the relationships
that are most commonly traversed.</p>
<p>All in all Neo4j has been designed to be very adaptive depending on how it
is used. The (unachievable) overall goal is to be able to handle any incoming
operation without having to go down and work with the file/disk I/O layer.</p>
</section>
<section class="section" id="_configuring_neo4j"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title">Configuring Neo4j</h3></div></div></div>

<p>See <a class="xref" href="configuration.html" title="Chapter 24. Configuration &amp; Performance">Chapter 24, <em>Configuration &amp; Performance</em></a> and <a class="xref" href="configuration-jvm.html" title="24.8. JVM Settings">Section 24.8, “JVM Settings”</a> for information on how to configure Neo4j and the JVM.
These settings have a lot of impact on performance.</p>
<section class="section" id="_disks_ram_and_other_tips"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Disks, RAM and other tips</h4></div></div></div>

<p>As always, as with any persistence solution, performance depends a lot on the
persistence media used. Better disks equals better performance.</p>
<p>If you have multiple disks or persistence media available it may be a
good idea to split the store files and transaction logs across those disks.
Having the store files running on disks with low seek time can do wonders for
non-cached read operations. Today a typical mechanical drive has an average
seek time of about 5ms, this can cause a query or traversal to be very slow
when the available amount of RAM is too small or the configuration for caches and memory mapping
is bad. A new good SATA enabled SSD has an average seek time of &lt;100 microseconds
meaning those scenarios will execute at least 50 times faster.</p>
<p>To avoid hitting disk you need more RAM. On a standard mechanical drive you
can handle graphs with a few tens of millions of primitives with 1-2GB of RAM.
4-8GB of RAM can handle graphs with hundreds of millions of primitives while you
need a good server with 16-32GB to handle billions of primitives. However, if you
invest in a good SSD you will be able to handle much larger graphs on less RAM.</p>
<p>Use tools like <code class="literal">vmstat</code> or
equivalent to gather information when your application is running. If you have high I/O
waits and not that many blocks going out/in to disks when running write/read
transactions it’s a sign that you need to tweak your Java heap, Neo4j cache
and memory mapping settings (maybe even get more RAM or better disks).</p>
</section>
<section class="section" id="_write_performance"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Write performance</h4></div></div></div>

<p>If you are experiencing poor write performance after writing some data
(initially fast, then massive slowdown) it may be the operating system that is
writing out dirty pages from the memory mapped regions of the store files.
These regions do not need to be written out to maintain consistency so to
achieve highest possible write speed that type of behavior should be avoided.</p>
<p>Another source of writes slowing down can be the transaction size. Many small
transactions result in a lot of I/O writes to disc and should be avoided.
Too big transactions can result in OutOfMemory errors, since the uncommitted
transaction data is held on the Java Heap in memory. For details about transaction
management in Neo4j, please see <a class="xref" href="transactions.html" title="Chapter 18. Transaction Management">Chapter 18, <em>Transaction Management</em></a>.</p>
<p>The Neo4j kernel makes use of several store files and a logical log file
to store the graph on disk. The store files contain the actual graph and the
log contains modifying operations. All writes to the logical log are append-only
and when a transaction is committed changes to the logical log will be forced
(<code class="literal">fdatasync</code>) down to disk. The store files are however not flushed to disk and
writes to them are not append-only either. They will be written to in a more or
less random pattern (depending on graph layout) and writes will not be forced to
disk until the log is rotated or the Neo4j kernel is shut down.</p>
<p>Since random writes to memory mapped regions for the store files may
happen it is very important that the data does not get written out to disk unless
needed. Some operating systems have very aggressive settings regarding when to write
out these dirty pages to disk. If the OS decides to start writing out dirty pages
of these memory mapped regions, write access to disk will stop being sequential and
become random. That hurts performance a lot, so to get maximum write performance when
using Neo4j make sure the OS is configured not to write out any of the dirty pages
caused by writes to the memory mapped regions of the store files. As an example,
if the machine has 8GB of RAM and the total size of the store files is 4GB (fully
memory mapped) the OS has to be configured to accept at least 50% dirty pages in
virtual memory to make sure we do not get random disk writes.</p>
<div class="admonitionblock Note"><table><tr><td class="icon"><img alt="[Note]" src="images/icons/admon/note.svg" /></td><td class="content"><b>Note</b><p>Make sure to read <a class="xref" href="linux-performance-guide.html" title="24.12. Linux Performance Guide">Section 24.12, “Linux Performance Guide”</a> as well for more specific information.</p></td></tr></table></div>
</section>
<section class="section" id="_second_level_caching"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title">Second level caching</h4></div></div></div>

<p>While normally building applications and “always assume the graph is in memory”,
sometimes it is necessary to optimize certain performance critical sections.
Neo4j adds a small overhead even if the node, relationship or property in question
is cached compared to in-memory data structures. If this becomes an
issue, use a profiler to find these hot spots and then add your own second-level
caching. We believe second-level caching should be avoided to greatest extent
possible since it will force you to take care of invalidation which sometimes
can be hard. But when everything else fails you have to use it so here is an
example of how it can be done.</p>
<p>We have some POJO that wrapps a node holding its state. In this particular
POJO we have overridden the equals implementation.</p>
<pre class="programlisting" data-lang="java">   public boolean equals( Object obj )
   {
       return underlyingNode.getProperty( "some_property" ).equals( obj );
   }

   public int hashCode()
   {
       return underlyingNode.getProperty( "some_property" ).hashCode();
   }</pre>
<p>This works fine in most scenarios, but in this particular scenario many instances of that POJO is being worked with in nested loops adding/removing/getting/finding to collection classes.
Profiling the applications will show that the equals implementation is being called many times and can be viewed as a hot spot.
Adding second-level caching for the equals override will in this particular scenario increase performance.</p>
<pre class="programlisting" data-lang="java">    private Object cachedProperty = null;

    public boolean equals( Object obj )
    {
       if ( cachedProperty == null )
       {
           cachedProperty = underlyingNode.getProperty( "some_property" );
       }
       return cachedProperty.equals( obj );
    }

    public int hashCode()
    {
       if ( cachedPropety == null )
       {
           cachedProperty = underlyingNode.getProperty( "some_property" );
       }
       return cachedProperty.hashCode();
    }</pre>
<p>The problem with this is that now we need to invalidate the cached property whenever <code class="literal">some_property</code>
is changed (may not be a problem in this scenario since the state picked for equals and hash
code computation often won’t change).</p>
<div class="admonitionblock Tip"><table><tr><td class="icon"><img alt="[Tip]" src="images/icons/admon/tip.svg" /></td><td class="content"><b>Tip</b><p>To sum up, avoid second-level caching if possible and only add it when you really need it.</p></td></tr></table></div>
</section>
</section>
</section>

 <footer>
   <p>
   © Copyright
   <a href="http://creativecommons.org/licenses/by-sa/3.0/"><img id="copyright-img" src="images/by-sa.svg" alt="CC BY-SA 3.0" title="Creative Commons Attribution-ShareAlike 3.0"></a>
   <a href="http://neo4j.com/"><img id="neotech-logo" src="images/neo-technology.svg" alt="Neo Technology"></a>
   </p>
 </footer>
  <script type="text/javascript">

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    //Allow Linker
    ga('create', 'UA-1192232-34','auto', {'allowLinker': true});
    ga('send', 'pageview');

    // Load the plugin.
    ga('require', 'linker');

    // Define which domains to autoLink.
    ga('linker:autoLink', ['neo4j.org','neo4j.com','neotechnology.com','graphdatabases.com','graphconnect.com']);
  </script>

</div></body></html>